---
import { codeToHtml } from "shiki";

const { steps } = Astro.props;

// Configuration for info boxes
const infoBoxConfig = [
  {
    key: "callStack",
    title: "ü™ú Call Stack",
    bgClass: "bg-gray-100 dark:bg-gray-800",
    textClass: "",
    isStack: true,
  },
  {
    key: "scope",
    title: "üîç Scope",
    bgClass: "bg-green-100 dark:bg-green-900/30",
    textClass: "text-green-700 dark:text-green-300",
  },
];

// Pre-render syntax highlighted code for each step
const highlightedSteps = await Promise.all(
  steps.map(async (step: any) => {
    return {
      ...step,
      highlightedCode: await codeToHtml(step.code, {
        lang: "javascript",
        theme: "github-dark",
        transformers: [
          {
            line(node, line) {
              if (
                step.highlightLines &&
                step.highlightLines.includes(line - 1)
              ) {
                this.addClassToHast(node, "highlight");
              }
            },
          },
        ],
      }),
    };
  })
);
---

<div class="relative my-8">
  <div class="relative overflow-hidden">
    {
      highlightedSteps.map((step: any, index: number) => (
        <div class="carousel-slide hidden" data-slide={index}>
          <h3 class="text-xl font-semibold mb-4">{step.title}</h3>

          <div class="grid grid-cols-1 lg:grid-cols-[2fr_1fr] gap-4 items-start">
            <div class="flex flex-col min-h-full">
              <div
                class="rounded-lg overflow-x-auto text-sm flex-1 flex flex-col [&_.highlight]:bg-blue-500/15 [&_.highlight]:border-l-4 [&_.highlight]:border-blue-500 [&_.highlight]:pl-2 [&_.highlight]:-ml-2"
                set:html={step.highlightedCode}
              />
            </div>

            <div class="flex flex-col gap-4 min-h-full">
              {infoBoxConfig.map(
                ({ key, title, bgClass, textClass, isStack }) =>
                  step[key] && (
                    <div class={`rounded-lg p-4 ${bgClass}`}>
                      <h4 class="font-semibold mb-2 text-sm">{title}</h4>
                      <div
                        class={`text-xs font-mono ${isStack ? "space-y-1" : textClass}`}
                      >
                        {isStack ? (
                          step[key].map((call: string, i: number) => (
                            <div
                              class={`p-2 rounded ${i === 0 ? "bg-blue-500/20 border border-blue-500" : "bg-gray-200 dark:bg-gray-700"}`}
                            >
                              {call}
                            </div>
                          ))
                        ) : (
                          <pre class="whitespace-pre-wrap">{step[key]}</pre>
                        )}
                      </div>
                    </div>
                  )
              )}
            </div>
          </div>
        </div>
      ))
    }
  </div>

  <div class="flex justify-between items-center mt-4 gap-4">
    <button
      class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
      id="prev-btn"
    >
      ‚Üê Previous
    </button>
    <span class="text-sm text-gray-600 dark:text-gray-400" id="indicator">
      Step 1 of {steps.length}
    </span>
    <button
      class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
      id="next-btn"
    >
      Next ‚Üí
    </button>
  </div>
</div>

<script>
  const SLIDE_SELECTORS = {
    slides: ".carousel-slide",
    prevBtn: "#prev-btn",
    nextBtn: "#next-btn",
    indicator: "#indicator",
  } as const;

  let currentSlide = 0;
  const slides = document.querySelectorAll(SLIDE_SELECTORS.slides);
  const prevBtn = document.getElementById("prev-btn") as HTMLButtonElement;
  const nextBtn = document.getElementById("next-btn") as HTMLButtonElement;
  const indicator = document.getElementById("indicator");
  const totalSlides = slides.length;

  function showSlide(index: number) {
    slides.forEach((slide, i) => {
      if (i === index) {
        slide.classList.remove("hidden");
        slide.classList.add("block");
      } else {
        slide.classList.remove("block");
        slide.classList.add("hidden");
      }
    });

    if (prevBtn && nextBtn && indicator) {
      prevBtn.disabled = index === 0;
      nextBtn.disabled = index === totalSlides - 1;
      indicator.textContent = `Step ${index + 1} of ${totalSlides}`;
    }
  }

  function navigateSlide(direction: -1 | 1) {
    const newSlide = currentSlide + direction;
    if (newSlide >= 0 && newSlide < totalSlides) {
      currentSlide = newSlide;
      showSlide(currentSlide);
    }
  }

  prevBtn?.addEventListener("click", () => navigateSlide(-1));
  nextBtn?.addEventListener("click", () => navigateSlide(1));

  // Keyboard navigation
  document.addEventListener("keydown", (e) => {
    if (e.key === "ArrowLeft") {
      navigateSlide(-1);
    } else if (e.key === "ArrowRight") {
      navigateSlide(1);
    }
  });

  // Initialize
  showSlide(0);
</script>
